<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Leaflet Karte – Friedrichshafen</title>

    <!-- Leaflet CSS laut Kurzanleitung -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <!-- eigenes CSS: Kartenhöhe und Fixes (relativer Pfad wie gewünscht) -->
    <link rel="stylesheet" href="../src/css/leaflet_map.css" />

    <!-- Fallback, falls die eigene CSS Datei nicht geladen wird: stellt sicher, dass die Karte sichtbar ist -->
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        min-height: 60vh;
      }
      /* Leaflet Kachel Fix gegen globale img Regeln */
      .leaflet-container img {
        max-width: none;
      }
      .leaflet-container .leaflet-tile {
        width: 256px;
        height: 256px;
      }
    </style>
  </head>

  <body>
    <noscript>Für die Karte wird JavaScript benötigt.</noscript>

    <!-- Kartencontainer. Primäre Höhe kommt aus src/css/leaflet_map.css, 
         die Inline Styles oben sind nur Notfall Fallback. -->
    <div id="map" aria-label="Karte Friedrichshafen"></div>

    <!-- kleine Diagnose Box unten links -->
    <div
      id="diag"
      aria-live="polite"
      style="
        position: fixed;
        left: 8px;
        bottom: 8px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        font: 12px system-ui;
        border-radius: 6px;
        z-index: 1000;
      "
    ></div>

    <!-- Leaflet JS nach dem CSS laden -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      function diag(msg) {
        try {
          console.log("[diag]", msg);
          var el = document.getElementById("diag");
          if (el) el.textContent = msg;
        } catch (_) {}
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (typeof window.L === "undefined") {
          diag("Leaflet wurde nicht geladen");
          alert("Leaflet konnte nicht geladen werden");
          return;
        }
        var mapDiv = document.getElementById("map");
        var rect = mapDiv.getBoundingClientRect();
        if (rect.height < 100) {
          diag(
            "Hinweis: #map hat zu geringe Höhe (" +
              Math.round(rect.height) +
              " px). Prüfe src/css/leaflet_map.css",
          );
        }

        //Karte initialisieren auf Friedrichshafen
        var center = [47.651, 9.479];
        var map = L.map("map", { zoomControl: true }).setView(center, 13);

        var tiles = L.tileLayer(
          "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
          {
            maxZoom: 19,
            attribution:
              '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
          },
        ).addTo(map);

        var clickPopup = L.popup();
        map.on("click", function (e) {
          clickPopup
            .setLatLng(e.latlng)
            .setContent(
              "Klick bei " +
                e.latlng.lat.toFixed(5) +
                ", " +
                e.latlng.lng.toFixed(5),
            )
            .openOn(map);
        });

        console.assert(map instanceof L.Map, "Karte nicht erstellt");
        console.assert(
          document.querySelector(".leaflet-tile"),
          "Keine Tiles sichtbar",
        );

        window.addEventListener("resize", function () {
          map.invalidateSize();
        });
        setTimeout(function () {
          map.invalidateSize();
        }, 0);

        diag("Karte bereit – Friedrichshafen");
      });
    </script>
  </body>
</html>
